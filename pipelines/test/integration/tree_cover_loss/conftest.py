import dask.array as da
import geopandas as gpd
import numpy as np
import pytest
import xarray as xr
from shapely.geometry import box


@pytest.fixture
def tcl_ds():
    tcl = xr.Dataset(
        data_vars={
            "band_data": (
                ("band", "y", "x"),
                da.array([[[1, 1], [2, 2]]], dtype=np.uint8),
            )
        },
        coords={
            "band": np.array([0], dtype=np.int16),
            "y": np.array([1.0, 0.0], dtype=np.float64),
            "x": np.array([0.0, 1.0], dtype=np.float64),
        },
    )
    return tcl


@pytest.fixture
def pixel_area_ds():
    pixel_area = xr.Dataset(
        data_vars={
            "band_data": (
                ("band", "y", "x"),
                da.array([[[100.0, 150.0], [200.0, 250.0]]], dtype=np.float32),
            )
        },
        coords={
            "band": np.array([0], dtype=np.int16),
            "y": np.array([1.0, 0.0], dtype=np.float64),
            "x": np.array([0.0, 1.0], dtype=np.float64),
        },
    )
    return pixel_area


@pytest.fixture
def carbon_emissions_ds():
    carbon = xr.Dataset(
        data_vars={
            "carbon_emissions_MgCO2e": (
                ("band", "y", "x"),
                da.array([[[1000.0, 1500.0], [2000.0, 2500.0]]], dtype=np.float32),
            )
        },
        coords={
            "band": np.array([0], dtype=np.int16),
            "y": np.array([1.0, 0.0], dtype=np.float64),
            "x": np.array([0.0, 1.0], dtype=np.float64),
        },
    )
    return carbon


@pytest.fixture
def tcd_ds():
    tcd = xr.Dataset(
        data_vars={
            "band_data": (
                ("band", "y", "x"),
                da.array([[[5, 5], [6, 6]]], dtype=np.uint8),
            )
        },
        coords={
            "band": np.array([0], dtype=np.int16),
            "y": np.array([1.0, 0.0], dtype=np.float64),
            "x": np.array([0.0, 1.0], dtype=np.float64),
        },
    )
    return tcd


@pytest.fixture
def ifl_ds():
    ifl = xr.Dataset(
        data_vars={
            "band_data": (
                ("band", "y", "x"),
                da.array([[[0, 1], [0, 1]]], dtype=np.int16),
            )
        },
        coords={
            "band": np.array([0], dtype=np.int16),
            "y": np.array([1.0, 0.0], dtype=np.float64),
            "x": np.array([0.0, 1.0], dtype=np.float64),
        },
    )
    return ifl


@pytest.fixture
def drivers_ds():
    drivers = xr.Dataset(
        data_vars={
            "band_data": (
                ("band", "y", "x"),
                da.array([[[1, 1], [2, 2]]], dtype=np.int16),
            )
        },
        coords={
            "band": np.array([0], dtype=np.int16),
            "y": np.array([1.0, 0.0], dtype=np.float64),
            "x": np.array([0.0, 1.0], dtype=np.float64),
        },
    )
    return drivers


@pytest.fixture
def primary_forests_ds():
    primary_forests = xr.Dataset(
        data_vars={
            "band_data": (
                ("band", "y", "x"),
                da.array([[[0, 1], [0, 0]]], dtype=np.uint8),
            )
        },
        coords={
            "band": np.array([0], dtype=np.int16),
            "y": np.array([1.0, 0.0], dtype=np.float64),
            "x": np.array([0.0, 1.0], dtype=np.float64),
        },
    )
    return primary_forests


@pytest.fixture
def country_ds():
    country = xr.Dataset(
        data_vars={
            "band_data": (
                ("band", "y", "x"),
                da.array([[[4, 4], [8, 8]]], dtype=np.int16),
            )
        },
        coords={
            "band": np.array([0], dtype=np.int16),
            "y": np.array([1.0, 0.0], dtype=np.float64),
            "x": np.array([0.0, 1.0], dtype=np.float64),
        },
    )
    return country


@pytest.fixture
def region_ds():
    region = xr.Dataset(
        data_vars={
            "band_data": (
                ("band", "y", "x"),
                da.array([[[10, 10], [20, 20]]], dtype=np.uint8),
            )
        },
        coords={
            "band": np.array([0], dtype=np.int16),
            "y": np.array([1.0, 0.0], dtype=np.float64),
            "x": np.array([0.0, 1.0], dtype=np.float64),
        },
    )
    return region


@pytest.fixture
def subregion_ds():
    subregion = xr.Dataset(
        data_vars={
            "band_data": (
                ("band", "y", "x"),
                da.array([[[100, 101], [200, 201]]], dtype=np.int16),
            )
        },
        coords={
            "band": np.array([0], dtype=np.int16),
            "y": np.array([1.0, 0.0], dtype=np.float64),
            "x": np.array([0.0, 1.0], dtype=np.float64),
        },
    )
    return subregion


class FakeQCRepository:
    def load(self, aoi_id=None, aoi_type=None):
        return gpd.GeoDataFrame(geometry=[box(0, 0, 1, 1)])


class FakeGoogleEarthEngineDatasetRepository:
    def load(self, dataset, geometry, like=None):
        if dataset == "loss":
            return xr.Dataset(
                data_vars={
                    "loss": (
                        ("y", "x"),
                        np.array([[1, 0], [1, 1]], dtype=np.uint8),
                    ),
                    "treecover2000": (
                        ("y", "x"),
                        np.array([[40, 20], [50, 31]], dtype=np.uint8),
                    ),
                }
            )
        if dataset == "tcl_drivers":
            return xr.Dataset(
                data_vars={
                    "classification": (
                        ("y", "x"),
                        np.array([[1, 2], [1, 3]], dtype=np.uint8),
                    )
                }
            )
        if dataset == "area":
            return xr.DataArray(
                np.array([[10000, 10000], [10000, 20000]], dtype=np.float32),
                dims=("y", "x"),
                name="area",
            )
        raise ValueError(f"Unknown dataset: {dataset}")


class MatchingGoogleEarthEngineDatasetRepository:
    def load(self, dataset, geometry, like=None):
        if dataset == "loss":
            return xr.Dataset(
                data_vars={
                    "loss": (
                        ("y", "x"),
                        np.array([[1, 1], [1, 1]], dtype=np.uint8),
                    ),
                    "treecover2000": (
                        ("y", "x"),
                        np.array([[35, 35], [40, 40]], dtype=np.uint8),
                    ),
                }
            )
        if dataset == "tcl_drivers":
            return xr.Dataset(
                data_vars={
                    "classification": (
                        ("y", "x"),
                        np.array([[1, 1], [2, 2]], dtype=np.uint8),
                    )
                }
            )
        if dataset == "area":
            return xr.DataArray(
                np.array(
                    [[1000000.0, 1500000.0], [2000000.0, 2500000.0]], dtype=np.float32
                ),
                dims=("y", "x"),
                name="area",
            )
        raise ValueError(f"Unknown dataset: {dataset}")


ARG_1_28 = {
    "type": "MultiPolygon",
    "coordinates": [
        (
            (
                (-60.032363891999864, -35.11172103899986),
                (-60.0398216239999, -35.108840940999926),
                (-60.054641723999964, -35.09267806899993),
                (-60.068424223999955, -35.09051894999993),
                (-60.08236312799994, -35.0883407579999),
                (-60.09059906099998, -35.09041976799989),
                (-60.101768493999884, -35.09111022999997),
                (-60.1103057869999, -35.091121672999975),
                (-60.11504745399992, -35.089748381999925),
                (-60.12260437099991, -35.08573532099996),
                (-60.129455566999866, -35.084819792999895),
                (-60.132812498999954, -35.08103942899993),
                (-60.13840484599996, -35.076793669999915),
                (-60.14483261199996, -35.07231902999996),
                (-60.14602661099997, -35.071388243999934),
                (-60.14945602399996, -35.06876373299997),
                (-60.155914306999875, -35.06532668999995),
                (-60.1555976869999, -35.06504058899992),
                (-60.12419891299987, -35.035228728999925),
                (-60.125160217999905, -35.03450393599991),
                (-60.186687468999935, -34.98788070599983),
                (-60.23087692199982, -34.95433807399996),
                (-60.23285293699996, -34.952846526999906),
                (-60.224617003999924, -34.94561767499988),
                (-60.233737945999906, -34.93870162899992),
                (-60.30825805799992, -34.88202667299993),
                (-60.31089782699996, -34.88004684499998),
                (-60.2454414369999, -34.82564926099997),
                (-60.21726226899989, -34.80219268699989),
                (-60.20724487199982, -34.79384994599991),
                (-60.18355178899992, -34.774108885999965),
                (-60.20040130599995, -34.757926939999834),
                (-60.182319640999935, -34.74093627899998),
                (-60.19539642399991, -34.73072051999992),
                (-60.163242339999954, -34.70268249399987),
                (-60.11820602499995, -34.66337585499997),
                (-60.1104850779999, -34.656623840999885),
                (-60.06788253899998, -34.69021606499996),
                (-60.03610229499998, -34.6629714959999),
                (-60.01327514699989, -34.64491653499988),
                (-59.99545669499997, -34.66279601999997),
                (-59.99139404199991, -34.675876617999904),
                (-59.98721694899996, -34.68079757599986),
                (-59.98109817499994, -34.68332672199995),
                (-59.97525024299989, -34.68962097199983),
                (-59.97190856899988, -34.69317245399998),
                (-59.94638824599997, -34.671867369999916),
                (-59.920814514999904, -34.6921272269999),
                (-59.851779937999936, -34.74678039499992),
                (-59.830955503999974, -34.76322936899987),
                (-59.82708358799988, -34.76630782999996),
                (-59.82473373499988, -34.76424407899998),
                (-59.790672301999905, -34.78985214099998),
                (-59.81282424999989, -34.81330108499992),
                (-59.810977935999915, -34.82075500399992),
                (-59.80883407499988, -34.83131408699995),
                (-59.80155181899988, -34.834106444999975),
                (-59.79672241299983, -34.83597564699994),
                (-59.78846359299996, -34.84249496499996),
                (-59.78355407799995, -34.84509658799993),
                (-59.77730178799993, -34.84842681899994),
                (-59.7693290709999, -34.85701370299989),
                (-59.76060867299992, -34.87269973799994),
                (-59.751644134999935, -34.88196182199988),
                (-59.73713684099988, -34.88857269199991),
                (-59.726058958999886, -34.89451217599992),
                (-59.725254058999894, -34.894947050999974),
                (-59.714088439999955, -34.89962005499996),
                (-59.69701766999998, -34.9126358019999),
                (-59.68828964199997, -34.92590713399983),
                (-59.67609786999992, -34.93699264599991),
                (-59.6656227119999, -34.94364166299994),
                (-59.65707778899997, -34.94908523499993),
                (-59.65872955399993, -34.95171737599992),
                (-59.62767410299989, -34.969943999999884),
                (-59.60792541599989, -35.000839232999965),
                (-59.66546249399988, -35.04928588799993),
                (-59.70571899299995, -35.083122253999875),
                (-59.708099364999896, -35.08176040699988),
                (-59.75585555999987, -35.12160873399995),
                (-59.82888412499989, -35.182430266999916),
                (-59.829769133999946, -35.18215179399988),
                (-59.83245086699998, -35.17595672599998),
                (-59.83723068299997, -35.17103576599993),
                (-59.83894348099983, -35.16473007299993),
                (-59.84411621099997, -35.16268157899998),
                (-59.84969329799992, -35.162803649999944),
                (-59.85333251999987, -35.161899566999864),
                (-59.86088561899999, -35.161113737999926),
                (-59.86983108599992, -35.15987014699988),
                (-59.87543487599993, -35.15540313799994),
                (-59.876724243999945, -35.14875793399989),
                (-59.880096434999984, -35.14394760099998),
                (-59.881927489999896, -35.14027786199995),
                (-59.88878250099998, -35.13708114699995),
                (-59.89606094299984, -35.13170242299998),
                (-59.89719772299992, -35.12780761699992),
                (-59.90642929099994, -35.12254333599992),
                (-59.91369628899997, -35.12302017099995),
                (-59.92220687799983, -35.121772764999946),
                (-59.93015670799997, -35.12545776299993),
                (-59.93672561599993, -35.12398147599998),
                (-59.94300460699998, -35.12720107899992),
                (-59.95109939599996, -35.127895353999975),
                (-59.963645934999874, -35.13399124199998),
                (-59.97355651899983, -35.13871383599991),
                (-59.988220215999945, -35.13781738199992),
                (-60.00374603299997, -35.12597656199995),
                (-60.006553649999944, -35.12384033199993),
                (-60.01885223399995, -35.11696624699988),
                (-60.032363891999864, -35.11172103899986),
            ),
        )
    ],
}
