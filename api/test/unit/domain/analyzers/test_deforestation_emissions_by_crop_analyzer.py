import os

import pandas as pd
import pytest
import pytest_asyncio

from api.app.domain.analyzers.deforestation_emissions_by_crop import (
    DeforestationEmissionsByCropAnalyzer,
)
from api.app.models.land_change.deforestation_emissions_by_crop import (
    DeforestationEmissionsByCropAnalyticsIn,
)
from app.domain.models.analysis import Analysis
from app.infrastructure.external_services.duck_db_query_service import (
    DuckDbPrecalcQueryService,
)
from app.models.common.analysis import AnalysisStatus


class DummyAnalysisRepository:
    def __init__(self):
        self.analysis = None

    async def store_analysis(self, resource_id, analysis):
        self.analysis = analysis


class TestLandCoverChangeAdminAois:
    @pytest.fixture
    def parquet_mock_data(self):
        """Mock data that simulates the actual parquet file structure for the AOI"""
        data = {
            "aoi_id": [
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "BRA.12.3",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
                "IDN.24.9",
            ],
            "crop_type": [
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Yams",
                "Yams",
                "Yams",
                "Yams",
                "Yams",
                "Yams",
                "Yams",
                "Yams",
                "Yams",
                "Yams",
                "Yams",
                "Yams",
                "Yams",
                "Yams",
                "Yams",
                "Yams",
                "Yams",
                "Yams",
                "Yams",
                "Yams",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
                "Bananas",
            ],
            "gas_type": [
                "CH4",
                "CH4",
                "CH4",
                "CH4",
                "CH4",
                "CO2",
                "CO2",
                "CO2",
                "CO2",
                "CO2",
                "CO2e",
                "CO2e",
                "CO2e",
                "CO2e",
                "CO2e",
                "N2O",
                "N2O",
                "N2O",
                "N2O",
                "N2O",
                "CH4",
                "CH4",
                "CH4",
                "CH4",
                "CH4",
                "CO2",
                "CO2",
                "CO2",
                "CO2",
                "CO2",
                "CO2e",
                "CO2e",
                "CO2e",
                "CO2e",
                "CO2e",
                "N2O",
                "N2O",
                "N2O",
                "N2O",
                "N2O",
                "CH4",
                "CH4",
                "CH4",
                "CH4",
                "CH4",
                "CO2",
                "CO2",
                "CO2",
                "CO2",
                "CO2",
                "CO2e",
                "CO2e",
                "CO2e",
                "CO2e",
                "CO2e",
                "N2O",
                "N2O",
                "N2O",
                "N2O",
                "N2O",
            ],
            "year": [
                2020,
                2021,
                2022,
                2023,
                2024,
                2020,
                2021,
                2022,
                2023,
                2024,
                2020,
                2021,
                2022,
                2023,
                2024,
                2020,
                2021,
                2022,
                2023,
                2024,
                2020,
                2021,
                2022,
                2023,
                2024,
                2020,
                2021,
                2022,
                2023,
                2024,
                2020,
                2021,
                2022,
                2023,
                2024,
                2020,
                2021,
                2022,
                2023,
                2024,
                2020,
                2021,
                2022,
                2023,
                2024,
                2020,
                2021,
                2022,
                2023,
                2024,
                2020,
                2021,
                2022,
                2023,
                2024,
                2020,
                2021,
                2022,
                2023,
                2024,
            ],
            "emissions_factor": [
                0.001568,
                0.001589,
                0.001571,
                0.001527,
                0.003013,
                0.6913,
                0.6732,
                0.6756,
                0.6722,
                0.7202,
                0.6947,
                0.6765,
                0.6787,
                0.6752,
                0.725,
                0.001815,
                0.001694,
                0.001578,
                0.001476,
                0.001801,
                0.001525,
                0.001486,
                0.001465,
                0.001337,
                0.004524,
                1.374,
                1.246,
                1.123,
                0.9895,
                0.9576,
                1.38,
                1.252,
                1.128,
                0.9937,
                0.9654,
                0.004532,
                0.003998,
                0.003454,
                0.002871,
                0.003275,
                0.008329,
                0.006662,
                0.005385,
                0.004523,
                0.003872,
                0.8531,
                0.663,
                0.523,
                0.4288,
                0.36,
                0.8654,
                0.6726,
                0.5306,
                0.4351,
                0.3653,
                0.003912,
                0.002973,
                0.00229,
                0.001802,
                0.001428,
            ],
            "emissions_tonnes": [
                0.3461130844816348,
                0.361776450588094,
                0.3640167538779352,
                0.3489544882995355,
                0.6911470984101199,
                152.55722293309225,
                153.30344912460788,
                156.54748685438494,
                153.5611921382839,
                165.2308123155954,
                153.30383104803903,
                154.05096302027985,
                157.2770696784185,
                154.24725600395217,
                166.33523460965978,
                0.4004950304651978,
                0.3857374450839224,
                0.3655660701556949,
                0.3371093773687739,
                0.413275195654296,
                0.0968151880777734,
                0.0942264781761792,
                0.0930177541834309,
                0.0850748583713448,
                0.2876296042689517,
                87.1990116932254,
                79.00455663303975,
                71.3487906860215,
                62.96496087145693,
                60.881820645361,
                87.58347898946202,
                79.35222961330079,
                71.66117809421503,
                63.23275143660502,
                61.37768877119392,
                0.2876521081588512,
                0.2534465020848488,
                0.2193696540101006,
                0.1827157067767396,
                0.2082385215639586,
                6.446337696547037,
                5.507806111739093,
                4.7084756734365945,
                3.9938717518397233,
                3.3785613339823866,
                660.2565809171848,
                548.0853485308255,
                457.2977584010853,
                378.58780883923663,
                314.070154835051,
                669.7306681653587,
                556.0508758273431,
                464.00910667779254,
                384.1731028875324,
                318.6943499989886,
                3.0277495516268114,
                2.4577211847784133,
                2.002872603270611,
                1.5914222964559417,
                1.245633829955154,
            ],
            "production_tonnes": [
                220.68449819087243,
                227.71035512538788,
                231.72107104391625,
                228.4592202411875,
                229.42511670277213,
                220.68449819087243,
                227.71035512538788,
                231.72107104391625,
                228.4592202411875,
                229.42511670277213,
                220.68449819087243,
                227.71035512538788,
                231.72107104391625,
                228.4592202411875,
                229.42511670277213,
                220.68449819087243,
                227.71035512538788,
                231.72107104391625,
                228.4592202411875,
                229.42511670277213,
                63.46915191789824,
                63.39340532680385,
                63.51274217374873,
                63.632079020693595,
                63.57938882440044,
                63.46915191789824,
                63.39340532680385,
                63.51274217374873,
                63.632079020693595,
                63.57938882440044,
                63.46915191789824,
                63.39340532680385,
                63.51274217374873,
                63.632079020693595,
                63.57938882440044,
                63.46915191789824,
                63.39340532680385,
                63.51274217374873,
                63.632079020693595,
                63.57938882440044,
                773.9234356017172,
                826.7359119379604,
                874.430646889571,
                882.9244133109722,
                872.4515129721174,
                773.9234356017172,
                826.7359119379604,
                874.430646889571,
                882.9244133109722,
                872.4515129721174,
                773.9234356017172,
                826.7359119379604,
                874.430646889571,
                882.9244133109722,
                872.4515129721174,
                773.9234356017172,
                826.7359119379604,
                874.430646889571,
                882.9244133109722,
                872.4515129721174,
            ],
            "aoi_type": [
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
                "admin",
            ],
        }

        return pd.DataFrame(data)

    @pytest_asyncio.fixture(autouse=True)
    async def analyzer_with_test_data(self, parquet_mock_data):
        self.analysis_repo = DummyAnalysisRepository()
        table_name = "/tmp/test.parquet"
        parquet_mock_data.to_parquet("/tmp/test.parquet", index=False)

        query_service = DuckDbPrecalcQueryService(table_name)
        analyzer = DeforestationEmissionsByCropAnalyzer(
            analysis_repository=self.analysis_repo,
            compute_engine=None,
            query_service=query_service,
        )

        return analyzer

    @pytest_asyncio.fixture(autouse=True)
    async def run_analysis(
        self,
        analyzer_with_test_data,
    ):
        analytics_in = DeforestationEmissionsByCropAnalyticsIn(
            aoi={"type": "admin", "ids": ["BRA.12.1", "IDN.24.9"]},
            gas_types=["CO2e", "CH4"],
            crop_types=["Bananas"],
            start_year="2021",
            end_year="2023",
        )

        analysis = Analysis(
            metadata=analytics_in.model_dump(mode="json"),
            result=None,
            status=AnalysisStatus.pending,
        )

        await analyzer_with_test_data.analyze(analysis)

    def test_analysis_result(self):
        try:
            results = self.analysis_repo.analysis.result
            df = pd.DataFrame(results)

            assert len(df.columns) == 8
        finally:
            os.remove("/tmp/test.parquet")
